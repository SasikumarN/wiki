<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Memory, Overcommit and OOM, Stack overflow</title>
<!-- 2017-04-20 Thu 23:29 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Shi Shougang" />
<link href="../../assets/bootstrap.min.css" rel="stylesheet" media="screen">
<link href="../../assets/bootstrap-responsive.min.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="../../assets/stylesheet.css" />
<script src="assets/js/bootstrap.min.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">Memory, Overcommit and OOM, Stack overflow</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Some cases</a>
<ul>
<li><a href="#sec-1-1">OOM killer crashes</a></li>
</ul>
</li>
<li><a href="#sec-2">VM</a>
<ul>
<li><a href="#sec-2-1"><code>overcommit_ratio</code></a></li>
<li><a href="#sec-2-2"><code>vm.overcommit_ratio</code></a></li>
<li><a href="#sec-2-3"><code>vm.min_free_kbytes = 65536</code></a></li>
<li><a href="#sec-2-4"><code>vm.min_free_kbytes</code> &lt; lowmem</a></li>
<li><a href="#sec-2-5"><code>vm.swappiness = 0</code></a></li>
<li><a href="#sec-2-6"><code>vm.overcommit_memory=1</code></a></li>
</ul>
</li>
<li><a href="#sec-3">cc</a></li>
</ul>
</div>
</div>



<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Some cases</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">OOM killer crashes<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup></h3>
<div class="outline-text-3" id="text-1-1">
<p>
To fix OOM crash the behavior of the kernel has to be changed, so it
will no longer overcommit the memory for application requests. 
</p>

<div class="org-src-container">

<pre class="src src-sh">vm.overcommit_memory = 2
vm.overcommit_ratio = 80
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">VM</h2>
<div class="outline-text-2" id="text-2">
<p>
<a href="https://www.kernel.org/doc/Documentation/sysctl/vm.txt">https://www.kernel.org/doc/Documentation/sysctl/vm.txt</a>
</p>

<p>
<a href="http://russ.garrett.co.uk/2009/01/01/linux-kernel-tuning/">http://russ.garrett.co.uk/2009/01/01/linux-kernel-tuning/</a>
</p>
</div>
<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><code>overcommit_ratio</code></h3>
<div class="outline-text-3" id="text-2-1">
<p>
Which happened to be 50. And the machine just happened to have about
5GB of RAM. Well look there, 5×50 is 250GB
</p>

<p>
If a process tries to malloc() more memory than available it will get
an error right away. This mode is set by changing the sysctl value
vm.overcommit<sub>memory</sub> to 2.
</p>
</div>
</div>
<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><code>vm.overcommit_ratio</code></h3>
</div>

<div id="outline-container-sec-2-3" class="outline-3">
<h3 id="sec-2-3"><code>vm.min_free_kbytes = 65536</code></h3>
<div class="outline-text-3" id="text-2-3">
<p>
This tells the kernel to try and keep 64MB of RAM free at all times. It’s useful in two main cases:
</p>

<ul class="org-ul">
<li>Swap-less machines, where you don’t want incoming network traffic to
overwhelm the kernel and force an OOM before it has time to flush
any buffers.
</li>

<li>x86 machines, for the same reason: the x86 architecture only allows
DMA transfers below approximately 900MB of RAM. So you can end up
with the bizarre situation of an OOM error with tons of RAM free.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2-4" class="outline-3">
<h3 id="sec-2-4"><code>vm.min_free_kbytes</code> &lt; lowmem</h3>
<div class="outline-text-3" id="text-2-4">
<p>
vm.min<sub>free</sub><sub>kbytes</sub> 设定值高于LowTotal 值，系统认为没有足够的lowmem，而触发OOM Killer，将进程强行杀掉。
</p>

<p>
系统中内存分为lowmem和highmem，其中lowmem为寻址内存，当lowmem耗尽时，系统会触动OOM Killer将多余进程杀掉来释放内
</p>
</div>
</div>

<div id="outline-container-sec-2-5" class="outline-3">
<h3 id="sec-2-5"><code>vm.swappiness = 0</code></h3>
<div class="outline-text-3" id="text-2-5">
<p>
It’s said that altering swappiness can help you when you’re running
under high memory pressure with software that tries to do its own
memory management (i.e. MySQL). We’ve had limited success with this
and I’d much prefer to use software which doesn’t pretend to know more
about your hardware than the OS (i.e. PostgreSQL). Not that I’m
bitter.
</p>
</div>
</div>

<div id="outline-container-sec-2-6" class="outline-3">
<h3 id="sec-2-6"><code>vm.overcommit_memory=1</code></h3>
<div class="outline-text-3" id="text-2-6">
<p>
The overcommit<sub>memory</sub> sysctl isn’t something you’ll usually have to
change if your software isn’t insane, but our netboot setup uses it so
I thought I’d mention it. From the documentation:
</p>

<ol class="org-ol">
<li>- Heuristic overcommit handling. Obvious overcommits of address
space are refused. Used for a typical system. It ensures a
seriously wild allocation fails while allowing overcommit to reduce
swap usage. root is allowed to allocate slighly more memory in this
mode. This is the default.
</li>
<li>- Always overcommit. Appropriate for some scientific applications.
</li>
<li>- Don’t overcommit. The total address space commit for the system
is not permitted to exceed swap + a configurable percentage
(default is 50) of physical RAM. Depending on the percentage you
use, in most situations this means a process will not be killed
while accessing pages but will receive errors on memory allocation
as appropriate.
</li>
</ol>

<p>
For more info on this, see the overcommit accounting documentation.
<a href="https://www.kernel.org/doc/Documentation/sysctl/vm.txt">https://www.kernel.org/doc/Documentation/sysctl/vm.txt</a>
</p>
</div>
</div>
</div>



<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">cc</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">

<pre class="src src-sh"></pre>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
<a href="https://www.hskupin.info/2010/06/17/how-to-fix-the-oom-killer-crashe-under-linux/">https://www.hskupin.info/2010/06/17/how-to-fix-the-oom-killer-crashe-under-linux/</a>
</p></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Shi Shougang</p>
<p class="date">Created: 2017-04-20 Thu 23:29</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.3.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
